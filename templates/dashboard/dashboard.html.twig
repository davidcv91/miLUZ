{% extends "base.html.twig" %}
{% use "daterange_picker/settings.html.twig" %}

{% block title %}{{ parent() }}{{ 'nav.dashboard'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" type="text/css" href="{{ asset('css/daterangepicker.css') }}" />
{% endblock %}

{% block body %}

    <div class="container">
        <div class="row mt-3">
            <div class="col">
                <div class="card">
                    <h5 class="card-header">{{ 'dashboard.card.last_num_days_consumption.header'|trans({'%num%': 10}) }}</h5>
                    <div class="card-body">
                        <canvas id="day_consumption_chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row my-3">
            <div class="col">
                <div class="card">
                    <h5 class="card-header">{{ 'dashboard.card.day_consumption_hour.header'|trans }}</h5>
                    <div class="card-body">
                        <div id="block_day_selector">
                            <label class="my-1 mr-2 card-tex" for="day_picker">{{ 'dashboard.card.day_consumption_hour.select_day_label'|trans }}</label>
                            <button type="button" id="day_picker" class="btn btn-outline-primary dropdown-toggle">
                                <i class="far fa-calendar-alt"></i>&nbsp;
                                <span class="btn-text">{{ current_date }}</span>
                            </button>

                            <div class="alert alert-danger alert-dismissible fade show my-2" role="alert" style="display: none;">
                                <span class="alert-message"></span>
                                <button type="button" class="close alert-close-btn" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        </div>

                        <div class="mt-4">
                            <canvas id="hour_consumption_chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/moment.min.js') }}"></script>
    <script src="{{ asset('js/daterangepicker.min.js') }}"></script>
    <script src="{{ asset('js/Chart.bundle.min.js') }}"></script>
    {% block daterange_picker_settings %}{{ parent() }}{% endblock %}
    <script>
        $('document').ready(function () {

            daterange_picker_settings.singleDatePicker = true;
            daterange_picker_settings.startDate = moment();
            daterange_picker_settings.ranges = null;

            $('#day_picker').daterangepicker(daterange_picker_settings, function(date) {
                loadDayConsumptionChart(date.format('YYYY-MM-DD'));
                $('#day_picker .btn-text').text(date.format("{{ 'daterange_picker.date_format'|trans }}"))
            });

            $('#block_day_selector .alert-close-btn').on('click', function () {
                hideErrorAlert();
            });

            function loadDayConsumptionChart(day_date) {
                hideErrorAlert();

                $.ajax({
                    method: "POST",
                    url: "{{ path('day_stats_ajax') }}",
                    dataType: "json",
                    data: {
                        day_date: day_date,
                    }
                }).done(function( result ) {
                    if (!result.result) {
                        showErrorAlert(result.error_message);
                    } else {
                        buildHourConsumptionChart(result.result);
                    }
                });
            }

            buildDayConsumptionChart();
            loadDayConsumptionChart(moment().format('YYYY-MM-DD'));

            function showErrorAlert(error_message) {
                $('#block_day_selector .alert-message').html(error_message);
                $('#block_day_selector .alert').show();
            }

            function hideErrorAlert() {
                $('#block_day_selector .alert').hide();
            }
        });


        function buildDayConsumptionChart() {
            var chart_data = {
                labels: [
                    {% for date in consumption_last_days|keys %}
                    "{{ date | date("app.date_format" | trans) }}",
                    {% endfor %}
                ],
                data: [
                    {% for day_consumption in consumption_last_days %}
                    "{{ day_consumption | number_format(1) }}",
                    {% endfor %}
                ]
            };

            var ctx = document.getElementById('day_consumption_chart').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chart_data['labels'],
                    datasets: [{
                        label: "{{ 'common.consumption'|trans }} ({{ 'units.kilowatts_hour'|trans }})",
                        backgroundColor: '#248eff',
                        data: chart_data['data']
                    }]
                },
                options: {
                    legend: {
                        display: false
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }


        var hour_consumption_chart_instance = null;

        function buildHourConsumptionChart(data) {
            if (hour_consumption_chart_instance) {
                hour_consumption_chart_instance.destroy();
            }

            var chart_data = {
                'labels': [
                    {% for hour in 0..23 %}
                    "{{ '%02d'|format(hour) }}{{ 'units.hour'|trans }} - {{ '%02d'|format(hour+1) }}{{ 'units.hour'|trans }}",
                    {% endfor %}
                ],
                'data': data
            };

            var ctx = document.getElementById('hour_consumption_chart').getContext('2d');
            hour_consumption_chart_instance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chart_data['labels'],
                    datasets: [{
                        label: "{{ 'common.consumption'|trans }} ({{ 'units.watts_hour'|trans }})",
                        backgroundColor: '#ffc107',
                        borderColor: '#ffc107',
                        data: chart_data['data'],
                    }]
                },
                options: {
                    legend: {
                        display: false
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }
    </script>
{% endblock %}